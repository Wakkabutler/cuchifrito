<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Media Tracker - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #111827;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --card-bg: #1f2937;
            --card-border: #374151;
            --input-bg: #374151;
            --input-border: #4b5563;
            --btn-secondary-bg: #4b5563;
            --btn-secondary-hover-bg: #6b7280;
            --btn-danger-bg: #991b1b;
            --btn-danger-hover-bg: #b91c1c;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --chart-tick-color: #9ca3af;
        }

        html.light-mode {
            --bg-color: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --input-bg: #e5e7eb;
            --input-border: #d1d5db;
            --btn-secondary-bg: #d1d5db;
            --btn-secondary-hover-bg: #9ca3af;
            --btn-danger-bg: #ef4444;
            --btn-danger-hover-bg: #dc2626;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-tick-color: #4b5563;
        }
        /* --- END THEME VARIABLES --- */

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-active { background-color: #3b82f6; color: #ffffff; }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s, border-color 0.3s;
            position: relative;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .score { font-weight: 700; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; }
        .score-s { background-color: #f59e0b; color: #1f2937; }
        .score-a { background-color: #10b981; color: #1f2937; }
        .score-b { background-color: #3b82f6; color: #ffffff; }
        .score-c { background-color: #f97316; color: #ffffff; }
        .score-d { background-color: #ef4444; color: #ffffff; }
        .score-f { background-color: #7f1d1d; color: #ffffff; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sort-btn { background-color: var(--input-bg); color: var(--text-secondary); padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 500; transition: background-color 0.2s; }
        .sort-btn:hover { background-color: var(--btn-secondary-hover-bg); }
        .sort-btn-active { background-color: #3b82f6; color: white; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(17, 24, 39, 0.8); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--card-border); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; }
        .form-input { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary); border-radius: 0.375rem; padding: 0.75rem 1rem; width: 100%; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
        .form-checkbox { width: 1.25rem; height: 1.25rem; background-color: var(--input-bg); border: 1px solid var(--input-border); border-radius: 0.25rem; }
        .form-checkbox:checked { background-color: #3b82f6; border-color: #3b82f6; }
        .btn-primary { background-color: #3b82f6; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: var(--btn-secondary-bg); color: var(--text-primary); font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover-bg); }
        .btn-danger { background-color: var(--btn-danger-bg); color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; font-size: 0.875rem;}
        .btn-danger:hover { background-color: var(--btn-danger-hover-bg); }

        /* Edit/Delete Buttons on Card */
        .card-actions { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s; }
        .card:hover .card-actions, .list-item:hover .card-actions { opacity: 1; }
        .card-action-btn { background-color: rgba(55, 65, 81, 0.7); border-radius: 9999px; padding: 0.3rem; line-height: 0; }
        .card-action-btn:hover { background-color: #3b82f6; }
        .list-item { position: relative; } /* For positioning actions */
        
        /* Theme Toggle */
        #theme-toggle {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 9999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #theme-toggle:hover {
            background-color: var(--input-bg);
        }
    </style>
    <script>
        // Apply theme on initial load to prevent flash
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.add('light-mode');
        } else {
            document.documentElement.classList.remove('light-mode');
        }
    </script>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 relative">
             <div class="absolute top-0 right-0 flex items-center gap-2">
                 <button id="reset-data-btn" class="btn-danger" title="Reset all data to original lists">Reset Data</button>
                 <button id="theme-toggle" title="Toggle theme">
                     <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                     <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                 </button>
             </div>
            <h1 class="text-4xl font-bold tracking-tight pt-2">2025 Media Tracker</h1>
            <p class="text-lg text-gray-400 mt-2">A consolidated view of all things finished this year.</p>
        </header>

        <!-- Tabs -->
        <div class="mb-8 flex flex-wrap justify-center gap-2">
            <button class="tab px-4 py-2 rounded-md font-semibold transition tab-active" onclick="showTab('overview')">Overview</button>
            <button class="tab px-4 py-2 rounded-md font-semibold transition" onclick="showTab('ernie')">Ernie's List</button>
            <button class="tab px-4 py-2 rounded-md font-semibold transition" onclick="showTab('jon')">Jon's List</button>
            <button class="tab px-4 py-2 rounded-md font-semibold transition" onclick="showTab('gameclub')">GameClub</button>
        </div>

        <!-- Content Panes -->
        <main id="content-container">
            <div id="overview" class="tab-content fade-in"></div>
            <div id="ernie" class="tab-content hidden fade-in"></div>
            <div id="jon" class="tab-content hidden fade-in"></div>
            <div id="gameclub" class="tab-content hidden fade-in"></div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="media-modal" class="modal-overlay hidden">
        <div class="modal-content fade-in">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Item</h2>
            <form id="media-form">
                <input type="hidden" id="form-person">
                <input type="hidden" id="form-category">
                <input type="hidden" id="form-item-id">
                
                <div class="space-y-4">
                    <div id="form-title-group">
                        <label for="form-title" class="block text-sm font-medium text-gray-300 mb-1">Title</label>
                        <input type="text" id="form-title" class="form-input" required>
                    </div>
                    <div id="form-score-group">
                        <label for="form-score" class="block text-sm font-medium text-gray-300 mb-1">Score (e.g., 8.5 or B+)</label>
                        <input type="text" id="form-score" class="form-input">
                    </div>
                    <div id="form-date-group">
                        <label for="form-date" class="block text-sm font-medium text-gray-300 mb-1">Date Finished</label>
                        <input type="date" id="form-date" class="form-input">
                    </div>
                    <div id="form-platform-group">
                        <label for="form-platform" class="block text-sm font-medium text-gray-300 mb-1">Platform</label>
                        <input type="text" id="form-platform" class="form-input">
                    </div>
                     <div id="form-hours-group">
                        <label for="form-hours" class="block text-sm font-medium text-gray-300 mb-1">Hours</label>
                        <input type="number" id="form-hours" class="form-input">
                    </div>
                    <div id="form-imdb-group" class="hidden">
                        <label for="form-imdb" class="block text-sm font-medium text-gray-300 mb-1">IMDb Link (optional)</label>
                        <input type="url" id="form-imdb" class="form-input">
                    </div>
                    <!-- GameClub Specific Fields -->
                    <div id="form-gameclub-group" class="hidden space-y-2">
                         <label class="block text-sm font-medium text-gray-300 mb-1">Finished Status</label>
                         <div class="flex items-center gap-2">
                             <input type="checkbox" id="form-jon-finished" class="form-checkbox">
                             <label for="form-jon-finished">Jon</label>
                         </div>
                         <div class="flex items-center gap-2">
                             <input type="checkbox" id="form-ernie-finished" class="form-checkbox">
                             <label for="form-ernie-finished">Ernie</label>
                         </div>
                    </div>
                    <div id="form-coop-group" class="hidden">
                        <label class="block text-sm font-medium text-gray-300 mb-1">Status</label>
                        <div class="flex items-center gap-2">
                           <input type="checkbox" id="form-coop-finished" class="form-checkbox">
                           <label for="form-coop-finished">Finished</label>
                        </div>
                   </div>
                </div>

                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content fade-in w-full max-w-sm">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-modal-cancel" class="btn-secondary">Cancel</button>
                <button id="confirm-modal-confirm" class="btn-danger bg-red-600 hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, setDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DATA STORE ---
        let mediaData = { ernie: {}, jon: {}, gameclub: [], coop: [] };
        let scoreChartInstance; // To hold the chart instance
        let db, auth; // Firebase instances

        // Original CSV data for initial population
        const ernieDataCSV = `No.,Title,Date Finished,Platform,Hours,Score,,No.,Title,Date Finished,Score,,No.,Title,Score,,No.,Title,Score
1,Metaphor: ReFantazio,1/23/2025,Xbox S|X,130,10,,1,Uzumaki by Junji Ito,3/12/2025,A,,1,Mindhunter S1,A,,1,Venom: The Last Dance,D-
2,Shadow Generations,2/8/2025,Steamdeck,5,8.5,,2,All You Need is Kill by Hiroshi Sakurazaka,4/3/2025,A,,2,Mindhunter S2,A,,2,Speak No Evil,B-
3,Sonic Generations ,2/23/2025,Steamdeck,6,8.5,,3,The Cabin at the End of the World by Paul G. Tremblay,6/22/2025,C-,,3,Severance S1,S,,3,Heretic,A+
4,Metal Gear Solid,2/23/2025,Anbernic,8,10,,4,Gyo,7/2/2025,B,,4,Castlevania S1,A+,,4,Emilia Pérez,C-
5,A Way Out (With Jon),3/2/2025,Xbox S|X,7,8,,5,Shiver,7/14/2025,A,,5,Castlevania S2,A+,,5,Sonic 3,A
6,Dino Crisis,3/2/2025,PS5,8,8,,6,Tombs,7/28/2025,A,,6,Castlevania S3,A,,6,The Crow,A
7,Silent Hill,3/16/2025,PS5,6,9,,7,No Longer Human,8/4/2025,S,,7,Castlevania S4,A,,7,The Crow: City of Angels,D
8,Silent Hill 3,3/23/2025,PS5,7,8,,8,The Dissolving Classroom,8/11/2025,B+,,8,Castlevania Nocturne,A,,8,The Crow: Salvation,D
9,The Thing,4/13/2025,Steamdeck,10,7,,9,Fragments of Horror,8/18/2025,A-,,9,Fallout,S,,9,The Crow: Wicked Prayer,F
10,Alan Wake 2,4/20/2025,PS5,20,9.5,,10,Smashed,8/25/2025,A,,10,X-Men 97,A,,10,Final Fantasy Advent Children,B+
11,Clock Tower,4/28/2025,Anbernic,3,8,,11,Deserter,9/2/2025,B,,11,The Boys S4,A,,11,The Last Ronin,A
12,Parasite Eve,5/12/2025,PS5,10,9,,12,Lovesickness,9/9/2025,A,,12,The Bear S1,A,,12,The Last Ronin Part 2,A
13,Parasite Eve II,5/26/2025,PS5,15,8,,13,The Liminal Zone,9/16/2025,A,,13,The Bear S2,A,,13,The Strangers: Chapter 1,C
14,Lollipop Chainsaw,6/1/2025,PS5,8,7,,14,Mimi's Tales of Terror,9/23/2025,B,,14,The Bear S3,A,,14,The Strangers: Chapter 2,B
15,Final Fantasy VII Rebirth,6/29/2025,PS5,100,10,,15,Venus in the Blind Spot,9/30/2025,A,,15,Law & Order SVU S7,B,,15,The Strangers: Chapter 3,A
16,Kingdom Hearts IV,7/13/2025,PS5,40,9,,16,Black Paradox,10/7/2025,B+,,16,Interview with the Vampire S2,A,,16,The Substance,A+
17,Elden Ring: Shadow of the Erdtree,7/20/2025,PS5,80,10,,17,Sensor,10/14/2025,B,,17,Daredevil S1,A,,17,Drive,A
18,Death Stranding 2: On the Beach,7/29/2025,PS5,135,9,,18,,,,,18,The White Lotus S1,A+,,18,Monster Hunter,C+
19,Still Wakes the Deep: Siren's Rest,8/4/2025,Xbox S|X,3,8,,19,,,,,19,The White Lotus S2,B,,19,The Gorge,B+
20,Metroid Prime 4,8/11/2025,Switch,25,9.5,,20,,,,,20,Law & Order SVU S8,B,,20,MaXXXine,A+
21,Hollow Knight Silksong,8/18/2025,Switch,40,10,,21,,,,,21,Law & Order SVU S9,B,,21,Transformers One,B
22,Fable,8/25/2025,Xbox S|X,50,9,,22,,,,,22,Law & Order SVU S10,B,,22,Mufasa: The Lion King,D
23,Perfect Dark,9/2/2025,Xbox S|X,15,8.5,,23,,,,,23,Law & Order SVU S11,C+,,23,Nosferatu,B
24,South of Midnight,9/9/2025,Xbox S|X,20,9,,24,,,,,24,Andor S2,A+,,24,Superman Red Son,A
25,Clair Obscur: Expedition 33 ,9/16/2025,Xbox S|X,44,10,,25,,,,,25,Yellowjackets S3,B-,,25,Knock at the Cabin,B
26,Shadow Hearts,9/23/2025,Steamdeck,23,7,,26,,,,,26,Mad Bull 34,C+,,26,Tusk,F
27,Silent Hill,9/30/2025,Steamdeck,11,8,,27,,,,,27,Law & Order SVU S12,B-,,27,Ellysiun,B-
28,Death Stranding 2: On the Beach,,,,,,,,,,28,Law & Order SVU S13,A,,28,Thunderbolts*,B-
29,Fatal Frame,10/7/2025,Steamdeck,12,8.5,,29,,,,,29,Law & Order SVU S14,B+,,29,From the World of John Wick: Ballerina,C
30,Fatal Frame 2,10/14/2025,Steamdeck,14,9.5,,30,,,,,30,Law & Order SVU S15,B,,30,Jurassic World,B-
31,Fatal Frame 3,10/21/2025,Steamdeck,15,9,,31,,,,,31,Law & Order SVU S16,A-,,31,The Batman Part II,A+
32,Fatal Frame 4,10/28/2025,Steamdeck,13,8.5,,32,,,,,32,Law & Order SVU S17,B,,32,The Bride!,A
33,Fatal Frame 5,11/4/2025,Steamdeck,16,8,,33,,,,,33,Law & Order SVU S18,C,,33,Joker: Folie à Deux,A
34,Judas,11/11/2025,Xbox S|X,18,9,,34,,,,,34,Law & Order SVU S19,D,,34,The War of the Rohirrim,B+
35,BioShock 4,11/18/2025,Xbox S|X,22,9.5,,35,,,,,35,Law & Order SVU S20,F,,35,The Fantastic Four,B`;

        const jonDataCSV = `Category,No.,Title,Date Finished,Platform,Hours,Score
Video Game,1,Outer Worlds (PSPLUS),1/10/2025,PS5,28,8
Video Game,2,Shadowrun Returns (PSPLUS),1/18/2025,PS5,22,7
Video Game,3,Dishonored (Gamepass),1/25/2025,XBOX,11,9
Video Game,4,Silent Hill 2 Remake (Gamefly),2/1/2025,PS5,18,9
Video Game,5,Slitterhead (Gamefly),2/22/2025,PS5,15,7
Video Game,6,No Way Out (Gamepass),3/2/2025,XBOX,7,8
Video Game,7,Split/Second (Gamepass),3/8/2025,XBOX,12,9
Video Game,8,Terminator Resistance (PSPLUS),3/15/2025,PS5,16,8
Video Game,9,Robocop (Gamefly),3/29/2025,PS5,18,9
Video Game,10,Evil West (PSPLUS),4/5/2025,PS5,14,8
Video Game,11,Dead Island 2 (Gamepass),4/12/2025,XBOX,25,8
Video Game,12,Stellar Blade (Gamefly),5/3/2025,PS5,30,9
Video Game,13,Rise of The Ronin (Gamefly),5/17/2025,PS5,40,8
Video Game,14,FFVII Rebirth (Gamefly),6/14/2025,PS5,80,9
Video Game,15,Black Myth Wukong (Gamefly),8/31/2025,PS5,35,9
Video Game,16,Warhammer Space Marine 2 (Gamefly),9/13/2025,XBOX,15,8
Video Game,17,Silent Hill F (Gamefly),10/11/2025,PS5,16,8
Video Game,18,Avowed (Gamepass),11/22/2025,XBOX,30,9
Video Game,19,Indiana Jones (Gamepass),12/13/2025,XBOX,20,9
Book,1,Tomie,2/19/2025,,,B
Book,2,Neuromancer,2/23/2025,,,A
Book,3,The Dreams In The Witch House,3/5/2025,,,A
Book,4,The Pentagon's Brain,7/11/2025,,,A
Book,5,Department of Truth Vol 5,7/13/2025,,,A
TV,1,Vinland Saga,,,,A
TV,2,Sakamoto Days,,,,B
TV,3,American Primeval,,,,A
TV,4,Onimusha,,,,B
TV,5,Alice In Borderlands,,,,A
TV,6,Common Side Effects,,,,
TV,7,Solo Leveling S2,,,,
TV,8,Severance S1,,,,
TV,9,Babylon 5 S2,,,,
TV,10,Daredevil Born Again,,,,
TV,11,Severance Season 2,,,,
TV,12,Hyouka,,,,
TV,13,Lazarus,,,,
TV,14,Night Agent S2,,,,
TV,15,Goku Midnight Eye,,,,
TV,16,The Bondsman,,,,
TV,17,Black Mirror S7,,,,
TV,18,The Last Drive In S7,,,,
TV,19,Last of Us S2 (Ongoing),,,,
TV,20,Andor S 2,,,,
TV,21,Xfiles S1,,,,
TV,22,Star Blazers 2199,,,,
TV,23,Mobile Suit Gundam GQuuuuuuX,,,,
TV,24,AD Police,,,,
Movie,1,Den of Thieves Pantera,,,,B
Movie,2,The Silent Hour,,,,C
Movie,3,The Rock,,,,A
Movie,4,American Star,,,,C
Movie,5,Redemption,,,,B
Movie,6,The Killer,,,,A
Movie,7,The Raid,,,,A
Movie,8,The Raid 2,,,,A
Movie,9,Dredd,,,,A
Movie,10,Upgrade,,,,A
Movie,11,District 9,,,,A
Movie,12,Hardcore Henry,,,,B
Movie,13,The Night Comes For Us,,,,A
Movie,14,Headshot,,,,B
Movie,15,Beyond Skyline,,,,C
Movie,16,The Equalizer 3,,,,B
Movie,17,The Beekeeper,,,,C
Movie,18,Civil War,,,,A
Movie,19,The Accountant 2,,,,B
Movie,20,Mickey 17,,,,C
Movie,21,Nosferatu,,,,A
Movie,22,Megalopolis,,,,A
Movie,23,The Bikeriders,,,,B
Movie,24,A Quiet Place Day One,,,,A
Movie,25,Bad Boys 4,,,,B
Movie,26,Beverly Hills Cop 4,,,,C
Movie,27,Borderlands,,,,C
Movie,28,Carry On,,,,B
Movie,29,Deadpool 3,,,,A
Movie,30,The Fall Guy,,,,B
Movie,31,Furiosa,,,,A
Movie,32,Horizon,,,,B
Movie,33,Inside Out 2,,,,A
Movie,34,Kingdom of The Planet of The Apes,,,,A
Movie,35,Maxxxine,,,,A
Movie,36,Godzilla X Kong,,,,B
Movie,37,Ghostbusters,,,,C
Movie,38,Twisters,,,,A
Movie,39,Dune 2,,,,A
Movie,40,The Watchers,,,,B
Movie,41,Thanksgiving,,,,A
Movie,42,The Creator,,,,B
Movie,43,Rebel Moon,,,,C
Movie,44,The Holdovers,,,,A
Movie,45,Past Lives,,,,A
Movie,46,Priscilla,,,,B
Movie,47,The Iron Claw,,,,A
Movie,48,Poor Things,,,,A
Movie,49,Saltburn,,,,B
Movie,50,Dream Scenario,,,,A
Movie,51,American Fiction,,,,A
Movie,52,The Color Purple,,,,B
Movie,53,Aquaman 2,,,,C
Movie,54,The Warriors: Walled In,,,,A
Movie,55,Pacific Rim,,,,A
Movie,56,Pacific Rim Uprising,,,,C
Movie,57,976 Evil,,,,B
Movie,58,Out of The Dark,,,,C
Movie,59,Demon City,,,,B
Movie,60,Campfire Tales,,,,A
Movie,61,Pulse,,,,B
Movie,62,The Bye Bye Man,,,,C
Movie,63,Wraith,,,,A
Movie,64,24 Hours To Live,,,,B
Movie,65,Slice,,,,C
Movie,66,Avengement,,,,A
Movie,67,Y2K,,,,C
Movie,68,Logan,,,,A
Movie,69,The Intruder,,,,B
Movie,70,Opera,,,,B
Movie,71,To Live and Die In LA,,,,A
Movie,72,Phantasm,,,,B
Movie,78,The Hitman,,,,C
Movie,79,City of Industry,,,,B
Movie,80,Sinners,,,,A
Movie,81,New Life,,,,B
Movie,82,Havoc,,,,C
Movie,83,Deadfall,,,,Schlock
Movie,84,Surrogates,,,,C
Movie,85,The Order,,,,B
Movie,86,Boy Kills World,,,,C
Movie,87,Hangman,,,,Schlock
Movie,88,Twisted,,,,C
Movie,89,Enemy,,,,B
Movie,90,Drive,,,,A
Movie,91,Azrael,,,,B
Movie,92,The 6th Day,,,,C
Movie,93,Classified,,,,Schlock
Movie,94,Chief of Station,,,,Schlock
Movie,95,The Wolfman,,,,B`;
        
        // --- FIREBASE SETUP ---
        const setupFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                if (!firebaseConfigStr) {
                    throw new Error("Firebase config is not available.");
                }
                const firebaseConfig = JSON.parse(firebaseConfigStr);

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase initialized and user authenticated.");
                
                // Check if data needs to be seeded
                await seedInitialData();

                // Setup real-time listeners
                setupListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = `<div class="text-red-400 p-8">Failed to connect to the database. Please ensure the environment is configured correctly.</div>`;
            }
        };
        
        const parseCSVToJSONForStorage = (csv, isFlat = false) => {
            const lines = csv.split('\n').filter(line => line.trim() !== '' && !line.startsWith('No.') && !line.startsWith('Category'));
            
            const data = { games: [], books: [], shows: [], movies: [] };

            lines.forEach(line => {
                const values = line.split(',');
                if (isFlat) {
                    const category = (values[0] || '').toLowerCase().trim().replace(' ', '_');
                    const item = {
                        no: values[1] || '',
                        title: values[2] || '',
                        date: (values[3] || '').replace(/"/g, ''),
                        platform: values[4] || '',
                        hours: values[5] || '',
                        score: values[6] || ''
                    };
                    if (category === 'video_game' && item.title) data.games.push(item);
                    else if (category === 'book' && item.title) data.books.push(item);
                    else if (category === 'tv' && item.title) data.shows.push(item);
                    else if (category === 'movie' && item.title) data.movies.push(item);

                } else {
                     // Games (cols 0-5)
                    if (values[1] && values[1].trim()) {
                        const dateParts = (values[2] || '').split('/');
                        const formattedDate = dateParts.length === 3 ? `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}` : '';
                        data.games.push({ 
                            no: values[0] || '', 
                            title: values[1] || '', 
                            date: formattedDate, 
                            platform: values[3] || '', 
                            hours: values[4] || '', 
                            score: values[5] || '' 
                        });
                    }
                    // Books (cols 7-10)
                    if (values[7] && values[8]) {
                        const dateParts = (values[9] || '').split('/');
                        const formattedDate = dateParts.length === 3 ? `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}` : '';
                        data.books.push({ 
                            no: values[7] || '', 
                            title: values[8] || '', 
                            date: formattedDate, 
                            score: values[10] || '' 
                        });
                    }
                    // TV Shows (cols 12-14)
                    if (values[12] && values[13]) {
                        data.shows.push({ 
                            no: values[12] || '', 
                            title: values[13] || '', 
                            score: values[14] || '' 
                        });
                    }
                    // Movies (cols 16-18)
                    if (values[16] && values[17]) {
                        data.movies.push({ 
                            no: values[16] || '', 
                            title: values[17] || '', 
                            score: values[18] || '' 
                        });
                    }
                }
            });
            return data;
        };

        // --- DATA SEEDING ---
        const seedInitialData = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const checkRef = collection(db, `artifacts/${appId}/public/data/ernie_games`);
            const checkSnapshot = await getDocs(checkRef);

            if (checkSnapshot.empty) {
                console.log("Database is empty. Seeding initial data...");
                const batch = writeBatch(db);

                const initialErnieData = parseCSVToJSONForStorage(ernieDataCSV);
                Object.keys(initialErnieData).forEach(category => {
                    initialErnieData[category].forEach(item => {
                        const docRef = doc(collection(db, `artifacts/${appId}/public/data/ernie_${category}`));
                        batch.set(docRef, item);
                    });
                });

                const initialJonData = parseCSVToJSONForStorage(jonDataCSV, true); // Use flat parser
                 Object.keys(initialJonData).forEach(category => {
                    initialJonData[category].forEach(item => {
                        const docRef = doc(collection(db, `artifacts/${appId}/public/data/jon_${category}`));
                        batch.set(docRef, item);
                    });
                });

                // Seed GameClub data
                const initialGameClub = [
                    { title: 'Castlevania Lords of Shadow', jon: 'FALSE', ernie: 'FALSE' },
                    { title: 'Tomb Raider Anniversary', jon: 'FALSE', ernie: 'FALSE' },
                    { title: 'Final Fantasy XIII', jon: 'FALSE', ernie: 'FALSE' },
                    { title: 'Lies of P', jon: 'TRUE', ernie: 'FALSE' },
                    { title: 'Mad Max', jon: 'FALSE', ernie: 'FALSE' },
                    { title: 'Parasite Eve II', jon: 'FALSE', ernie: 'TRUE' },
                    { title: 'Dino Crisis', jon: 'FALSE', ernie: 'TRUE' },
                ];
                initialGameClub.forEach(item => {
                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/gameclub`));
                    batch.set(docRef, item);
                });
                
                const initialCoop = [
                     { title: 'Dying Light 2', finished: 'FALSE' },
                     { title: 'A Way Out', finished: 'TRUE' },
                     { title: 'Ghost Recon Breakpoint', finished: 'FALSE' },
                     { title: 'MGS PeaceWalker', finished: 'FALSE' },
                     { title: 'Diablo II Remastered', finished: 'FALSE' },
                     { title: 'Split Fiction', finished: 'TRUE' },
                     { title: 'Darksiders Genesis', finished: 'FALSE' },
                ];
                initialCoop.forEach(item => {
                    const docRef = doc(collection(db, `artifacts/${appId}/public/data/coop`));
                    batch.set(docRef, item);
                });

                await batch.commit();
                console.log("Initial data seeded successfully.");
            } else {
                console.log("Database already contains data. Skipping seed.");
            }
        };
        
        // --- REAL-TIME LISTENERS ---
        const setupListeners = () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const categories = ['games', 'movies', 'shows', 'books'];
            
            // Listen to Ernie's data
            categories.forEach(category => {
                const collRef = collection(db, `artifacts/${appId}/public/data/ernie_${category}`);
                onSnapshot(collRef, (snapshot) => {
                    mediaData.ernie[category] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rerenderAll();
                });
            });

            // Listen to Jon's data
            categories.forEach(category => {
                const collRef = collection(db, `artifacts/${appId}/public/data/jon_${category}`);
                onSnapshot(collRef, (snapshot) => {
                    mediaData.jon[category] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rerenderAll();
                });
            });
            
            // Listen to GameClub data
            const gameclubRef = collection(db, `artifacts/${appId}/public/data/gameclub`);
            onSnapshot(gameclubRef, (snapshot) => {
                mediaData.gameclub = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAll();
            });
            
            const coopRef = collection(db, `artifacts/${appId}/public/data/coop`);
            onSnapshot(coopRef, (snapshot) => {
                mediaData.coop = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAll();
            });
        };

        // --- UTILITY FUNCTIONS ---
        const getScoreClass = (score) => {
            if (!score) return '';
            const numScore = convertScoreToNumber(score);
            if (numScore >= 9.5) return 'score-s';
            if (numScore >= 8.5) return 'score-a';
            if (numScore >= 7.5) return 'score-b';
            if (numScore >= 6.5) return 'score-c';
            if (numScore >= 5.5) return 'score-d';
            return 'score-f';
        };

        const convertScoreToNumber = (score) => {
            if (!score) return 0;
            const s = score.toString().toLowerCase().trim();
            if (!isNaN(s)) return parseFloat(s);
            const scoreMap = { 's': 10, 'a+': 9.8, 'a': 9.5, 'a-': 9.2, 'b+': 8.8, 'b': 8.5, 'b-': 8.2, 'c+': 7.8, 'c': 7.5, 'c-': 7.2, 'd+': 6.8, 'd': 6.5, 'd-': 6.2, 'f': 5.0, 'schlock': 4.0 };
            return scoreMap[s] || 0;
        };
        
        // --- MODAL & FORM HANDLING ---
        const modal = document.getElementById('media-modal');
        const form = document.getElementById('media-form');
        const confirmModal = document.getElementById('confirm-modal');

        // Custom confirm function
        const showConfirm = (title, text) => {
            return new Promise((resolve) => {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-text').textContent = text;
                confirmModal.classList.remove('hidden');

                const confirmBtn = document.getElementById('confirm-modal-confirm');
                const cancelBtn = document.getElementById('confirm-modal-cancel');

                const close = (result) => {
                    confirmModal.classList.add('hidden');
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true)); // Remove listeners
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    resolve(result);
                };

                confirmBtn.addEventListener('click', () => close(true));
                cancelBtn.addEventListener('click', () => close(false));
            });
        };


        window.openModal = (person, category, itemId = null) => {
            form.reset();
            document.getElementById('form-person').value = person;
            document.getElementById('form-category').value = category;
            document.getElementById('form-item-id').value = itemId || '';

            ['form-title-group', 'form-score-group', 'form-date-group', 'form-platform-group', 'form-hours-group', 'form-gameclub-group', 'form-coop-group', 'form-imdb-group'].forEach(id => document.getElementById(id).style.display = 'none');
            
            document.getElementById('form-title-group').style.display = 'block';

            if (person === 'gameclub') {
                if (category === 'gameclub') {
                    document.getElementById('form-gameclub-group').style.display = 'block';
                } else { // coop
                    document.getElementById('form-coop-group').style.display = 'block';
                }
            } else {
                document.getElementById('form-score-group').style.display = 'block';
                const isGame = category === 'games';
                const isBook = category === 'books';
                document.getElementById('form-platform-group').style.display = isGame ? 'block' : 'none';
                document.getElementById('form-hours-group').style.display = isGame ? 'block' : 'none';
                document.getElementById('form-date-group').style.display = 'block';
                if (!isGame && !isBook) {
                    document.getElementById('form-imdb-group').style.display = 'block';
                }
            }


            if (itemId) {
                document.getElementById('modal-title').innerText = 'Edit Item';
                const dataList = person === 'gameclub' ? mediaData[category] : mediaData[person][category];
                const item = dataList.find(i => i.id == itemId);
                if (item) {
                    document.getElementById('form-title').value = item.title || '';
                    if (person !== 'gameclub') {
                        document.getElementById('form-score').value = item.score || '';
                        if(item.date) document.getElementById('form-date').value = item.date;
                        if(category === 'games') {
                            document.getElementById('form-platform').value = item.platform || '';
                            document.getElementById('form-hours').value = item.hours || '';
                        }
                        if(category === 'movies' || category === 'shows'){
                            document.getElementById('form-imdb').value = item.imdbLink || '';
                        }
                    } else if (category === 'gameclub') {
                        document.getElementById('form-jon-finished').checked = item.jon === 'TRUE';
                        document.getElementById('form-ernie-finished').checked = item.ernie === 'TRUE';
                    } else { // coop
                        document.getElementById('form-coop-finished').checked = item.finished === 'TRUE';
                    }
                }
            } else {
                document.getElementById('modal-title').innerText = 'Add New Item';
            }
            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
        };

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const person = document.getElementById('form-person').value;
            const category = document.getElementById('form-category').value;
            const itemId = document.getElementById('form-item-id').value;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let newItemData = { title: document.getElementById('form-title').value };
            let collectionPath;

            if (person === 'gameclub') {
                collectionPath = `artifacts/${appId}/public/data/${category}`;
                if (category === 'gameclub') {
                    newItemData.jon = document.getElementById('form-jon-finished').checked ? 'TRUE' : 'FALSE';
                    newItemData.ernie = document.getElementById('form-ernie-finished').checked ? 'TRUE' : 'FALSE';
                } else { // coop
                    newItemData.finished = document.getElementById('form-coop-finished').checked ? 'TRUE' : 'FALSE';
                }
            } else {
                collectionPath = `artifacts/${appId}/public/data/${person}_${category}`;
                newItemData.score = document.getElementById('form-score').value;
                newItemData.date = document.getElementById('form-date').value;
                newItemData.platform = document.getElementById('form-platform').value;
                newItemData.hours = document.getElementById('form-hours').value;
                 if(category === 'movies' || category === 'shows'){
                    newItemData.imdbLink = document.getElementById('form-imdb').value;
                }
            }

            try {
                if (itemId) {
                    const docRef = doc(db, collectionPath, itemId);
                    await setDoc(docRef, newItemData, { merge: true });
                } else {
                    await addDoc(collection(db, collectionPath), newItemData);
                }
                closeModal();
            } catch (error) {
                console.error("Error writing to database:", error);
                showConfirm("Error", "Could not save item. Please try again.");
            }
        };

        window.deleteItem = async (person, category, itemId) => {
            const confirmed = await showConfirm('Delete Item?', 'Are you sure you want to delete this item? This action cannot be undone.');
            if (confirmed) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = person === 'gameclub' 
                    ? `artifacts/${appId}/public/data/${category}`
                    : `artifacts/${appId}/public/data/${person}_${category}`;
                
                try {
                    await deleteDoc(doc(db, collectionPath, itemId));
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showConfirm("Error", "Could not delete item. Please try again.");
                }
            }
        };
        
        window.resetData = async () => {
              const confirmed = await showConfirm(
                  'Reset All Data?', 
                  'This will delete any items you have added or edited and restore the original lists.'
              );
              if (confirmed) {
                 const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                 const collectionsToDelete = [
                     `artifacts/${appId}/public/data/ernie_games`,
                     `artifacts/${appId}/public/data/ernie_movies`,
                     `artifacts/${appId}/public/data/ernie_shows`,
                     `artifacts/${appId}/public/data/ernie_books`,
                     `artifacts/${appId}/public/data/jon_games`,
                     `artifacts/${appId}/public/data/jon_movies`,
                     `artifacts/${appId}/public/data/jon_shows`,
                     `artifacts/${appId}/public/data/jon_books`,
                     `artifacts/${appId}/public/data/gameclub`,
                     `artifacts/${appId}/public/data/coop`,
                 ];

                 const deleteCollection = async (path) => {
                     const querySnapshot = await getDocs(collection(db, path));
                     const batch = writeBatch(db);
                     querySnapshot.forEach((doc) => {
                         batch.delete(doc.ref);
                     });
                     await batch.commit();
                 };

                 Promise.all(collectionsToDelete.map(path => deleteCollection(path)))
                     .then(() => {
                         console.log("All collections cleared.");
                         // Now we can re-seed
                         seedInitialData().then(() => location.reload());
                     })
                     .catch(error => {
                         console.error("Error clearing data:", error);
                     });
             }
        };

        // --- RENDER FUNCTIONS ---
        const createCard = (item, type, person, category) => {
            if (!item.title || item.title.trim() === '') return '';
            let imdbLinkHTML = '';
            if (item.imdbLink) {
                imdbLinkHTML = `
                    <a href="${item.imdbLink}" target="_blank" class="card-action-btn" title="View on IMDb">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-yellow-400" viewBox="0 0 16 16">
                            <path d="M8.069 1.356A4.032 4.032 0 0 1 11.953.513c.412.083.78.27.982.522.24.3.293.66.134 1.016l-.396.903c-.23.523-.034.935.396 1.144.43.21.829-.023 1.072-.466l.422-.762c.24-.43.66-.66.982-.522.412.083.562.466.422.865l-1.144 3.28c-.14.4-.43.66-.829.66-.43 0-.627-.27-.829-.66L13.25 7.23c-.24-.522-.66-.762-.982-.865-.412-.083-.78.083-.982.466l-.562 1.016c-.24.43-.034.865.396 1.072.43.21.829-.023 1.072-.466l.396-.762c.24-.43.66-.66.982-.522.412.083.562.466.422.865l-2.24 6.562c-.14.4-.43.66-.829.66-.43 0-.627-.27-.829-.66l-1.144-2.586c-.24-.522-.66-.762-.982-.865s-.78.083-.982.466l-.562 1.016c-.24.43-.034.865.396 1.072.43.21.829-.023 1.072-.466l.396-.762c.24-.43.66-.66.982-.522.412.083.562.466.422.865l-2.24 6.562c-.14.4-.43.66-.829.66-.43 0-.627-.27-.829-.66L6.2 13.1c-.24-.522-.66-.762-.982-.865-.412-.083-.78.083-.982.466l-.562 1.016c-.24.43-.034.865.396 1.072.43.21.829-.023 1.072-.466l.396-.762c.24-.43.66-.66.982-.522.412.083.562.466.422.865L4.047 15.487c-.14.4-.43.66-.829.66-.43 0-.627-.27-.829-.66L1.245 9.62c-.14-.4.01-.782.422-.865.322-.098.742.134.982.522l.422.762c.24.43.66.66.982.522.412-.083.78-.27.982-.522.24-.3.293-.66.134-1.016l-.396-.903C4.54 7.6c-.23-.523-.034-.935.396-1.144.43-.21.829.023 1.072.466l.422.762c.24.43.66.66.982.522.412-.083.78-.27.982-.522.24-.3.293-.66.134-1.016L8.167.93c-.14-.4.01-.782.422-.865.322-.098.742.134.982.522L8.069 1.356z"/>
                        </svg>
                    </a>
                `;
            }
            return `
                <div class="card rounded-lg p-4 flex flex-col justify-between">
                    <div>
                        <p class="text-sm text-gray-400">${item.date || type}</p>
                        <h3 class="font-semibold mt-1">${item.title}</h3>
                        ${item.platform ? `<p class="text-xs text-gray-500 mt-1">${item.platform}${item.hours ? ` - ${item.hours} hrs` : ''}</p>` : ''}
                    </div>
                    ${item.score ? `<div class="mt-4 self-start"><span class="score ${getScoreClass(item.score)}">${item.score}</span></div>` : ''}
                    <div class="card-actions">
                        ${imdbLinkHTML}
                        <button class="card-action-btn" onclick="openModal('${person}', '${category}', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill text-white" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button>
                        <button class="card-action-btn" onclick="deleteItem('${person}', '${category}', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill text-white" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg></button>
                    </div>
                </div>`;
        };
        
        const createSection = (title, data, type, person) => {
            const category = type.toLowerCase().replace(/ & /g, '').replace(/ /g, '');
            const hasDate = data.some(item => item.date);
            return `
                <div class="mb-12">
                    <div class="flex flex-wrap justify-between items-center border-b-2 border-gray-700 pb-2 mb-6 gap-4">
                        <h2 class="text-2xl font-bold">${title} (${data.length})</h2>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2" id="sort-controls-${person}-${category}">
                                <span class="text-xs text-gray-400 mr-2">Sort by:</span>
                                <button class="sort-btn" onclick="sortAndRerender('${person}', '${category}', 'title', this)">Title</button>
                                <button class="sort-btn" onclick="sortAndRerender('${person}', '${category}', 'score', this)">Score</button>
                                ${hasDate ? `<button class="sort-btn" onclick="sortAndRerender('${person}', '${category}', 'date', this)">Date</button>` : ''}
                            </div>
                            <button class="btn-primary text-sm py-1 px-3" onclick="openModal('${person}', '${category}')">+ Add</button>
                        </div>
                    </div>
                    <div id="${person}-${category}-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${data.map(item => createCard(item, title, person, category)).join('')}
                    </div>
                </div>`;
        };
        
        const renderOverview = () => {
            const container = document.getElementById('overview');
            const ernieTotals = {
                games: mediaData.ernie.games?.length || 0,
                movies: mediaData.ernie.movies?.length || 0,
                shows: mediaData.ernie.shows?.length || 0,
                books: mediaData.ernie.books?.length || 0,
            };
             const jonTotals = {
                games: mediaData.jon.games?.length || 0,
                movies: mediaData.jon.movies?.length || 0,
                shows: mediaData.jon.shows?.length || 0,
                books: mediaData.jon.books?.length || 0,
            };

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                    <!-- Ernie's Totals -->
                    <div class="card rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4 text-center">Ernie's Totals</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${ernieTotals.games}</p>
                                <p class="text-sm text-gray-400">Games</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${ernieTotals.movies}</p>
                                <p class="text-sm text-gray-400">Movies</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${ernieTotals.shows}</p>
                                <p class="text-sm text-gray-400">Shows</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${ernieTotals.books}</p>
                                <p class="text-sm text-gray-400">Books</p>
                            </div>
                        </div>
                    </div>
                    <!-- Jon's Totals -->
                    <div class="card rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4 text-center">Jon's Totals</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${jonTotals.games}</p>
                                <p class="text-sm text-gray-400">Games</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${jonTotals.movies}</p>
                                <p class="text-sm text-gray-400">Movies</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${jonTotals.shows}</p>
                                <p class="text-sm text-gray-400">Shows</p>
                            </div>
                            <div class="text-center p-2 rounded-lg bg-gray-800/50">
                                <p class="text-4xl font-bold">${jonTotals.books}</p>
                                <p class="text-sm text-gray-400">Books</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card rounded-lg p-6">
                       <h2 class="text-2xl font-bold mb-4 text-center">Average Scores by Category</h2>
                       <canvas id="score-chart"></canvas>
                </div>
            `;
            renderAverageScoreChart();
        };

        const renderPersonPage = (containerId, data) => {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                ${createSection('Video Games', data.games || [], 'Games', containerId)}
                ${createSection('Movies', data.movies || [], 'Movies', containerId)}
                ${createSection('TV Shows', data.shows || [], 'Shows', containerId)}
                ${createSection('Books & Comics', data.books || [], 'Books', containerId)}`;
        };
        
        const renderGameClub = () => {
            const container = document.getElementById('gameclub');
            const createGameClubRow = (item) => `<li class="card list-item rounded-lg p-4 flex items-center justify-between"><span class="font-semibold">${item.title}</span><div class="flex items-center gap-4"><span class="flex items-center gap-2 text-sm">Jon: ${item.jon === 'TRUE' ? '✅' : '❌'}</span><span class="flex items-center gap-2 text-sm">Ernie: ${item.ernie === 'TRUE' ? '✅' : '❌'}</span></div><div class="card-actions"><button class="card-action-btn" onclick="openModal('gameclub', 'gameclub', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill text-white" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button><button class="card-action-btn" onclick="deleteItem('gameclub', 'gameclub', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill text-white" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg></button></div></li>`;
            const createCoopRow = (item) => `<li class="card list-item rounded-lg p-4 flex items-center justify-between"><span class="font-semibold">${item.title}</span><span class="text-sm">${item.finished === 'TRUE' ? '✅ Finished' : '❌ In Progress'}</span><div class="card-actions"><button class="card-action-btn" onclick="openModal('gameclub', 'coop', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill text-white" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></button><button class="card-action-btn" onclick="deleteItem('gameclub', 'coop', '${item.id}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill text-white" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/></svg></button></div></li>`;
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">GameClub List</h2><button class="btn-primary text-sm py-1 px-3" onclick="openModal('gameclub', 'gameclub')">+ Add</button></div><ul class="space-y-3">${(mediaData.gameclub || []).map(createGameClubRow).join('')}</ul></div><div><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Co-Op List</h2><button class="btn-primary text-sm py-1 px-3" onclick="openModal('gameclub', 'coop')">+ Add</button></div><ul class="space-y-3">${(mediaData.coop || []).map(createCoopRow).join('')}</ul></div></div>`;
        }

        window.sortAndRerender = (person, category, sortBy, clickedButton) => {
            if (clickedButton) {
                const controlsContainer = document.getElementById(`sort-controls-${person}-${category}`);
                controlsContainer.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('sort-btn-active'));
                clickedButton.classList.add('sort-btn-active');
            }
            const dataToSort = mediaData[person][category];
            dataToSort.sort((a, b) => {
                if (sortBy === 'title') return a.title.localeCompare(b.title);
                if (sortBy === 'score') return convertScoreToNumber(b.score) - convertScoreToNumber(a.score);
                if (sortBy === 'date') { if (!a.date) return 1; if (!b.date) return -1; return new Date(b.date) - new Date(a.date); }
                return 0;
            });
            const grid = document.getElementById(`${person}-${category}-grid`);
            grid.innerHTML = dataToSort.map(item => createCard(item, category, person, category)).join('');
        };

        const rerenderAll = () => {
            const currentTab = document.querySelector('.tab-active').getAttribute('onclick').match(/'([^']+)'/)[1];
            if (currentTab === 'overview') renderOverview();
            if (currentTab === 'ernie') renderPersonPage('ernie', mediaData.ernie);
            if (currentTab === 'jon') renderPersonPage('jon', mediaData.jon);
            if (currentTab === 'gameclub') renderGameClub();
        };

        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(button => button.classList.remove('tab-active'));
            document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('tab-active');
            rerenderAll(); // Rerender content when tab changes
        };

        const calculateCategoryAverages = (personData) => {
            const categories = ['games', 'movies', 'shows', 'books'];
            const averages = {};
            categories.forEach(cat => {
                const items = personData[cat] || [];
                const scoredItems = items.filter(item => item.score && item.score.trim() !== '');
                if (scoredItems.length === 0) {
                    averages[cat] = 0;
                    return;
                }
                const totalScore = scoredItems.reduce((sum, item) => sum + convertScoreToNumber(item.score), 0);
                averages[cat] = (totalScore / scoredItems.length).toFixed(2);
            });
            return averages;
        };

        const renderAverageScoreChart = () => {
            if (scoreChartInstance) {
                scoreChartInstance.destroy();
            }
            const ctx = document.getElementById('score-chart')?.getContext('2d');
            if(!ctx) return; // Don't render if canvas not visible
            
            const ernieAverages = calculateCategoryAverages(mediaData.ernie);
            const jonAverages = calculateCategoryAverages(mediaData.jon);
            
            const isLightMode = document.documentElement.classList.contains('light-mode');
            const gridColor = isLightMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const tickColor = isLightMode ? '#4b5563' : '#9ca3af';

            scoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Games', 'Movies', 'Shows', 'Books'],
                    datasets: [{
                        label: 'Ernie',
                        data: [ernieAverages.games, ernieAverages.movies, ernieAverages.shows, ernieAverages.books],
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Jon',
                        data: [jonAverages.games, jonAverages.movies, jonAverages.shows, jonAverages.books],
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: { color: gridColor },
                            ticks: { color: tickColor }
                        },
                        x: {
                            grid: { color: 'transparent' },
                            ticks: { color: tickColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: tickColor }
                        }
                    }
                }
            });
        };

        // --- THEME TOGGLE LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const root = document.documentElement;

        const updateThemeIcon = () => {
            if (root.classList.contains('light-mode')) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        };

        const toggleTheme = () => {
            root.classList.toggle('light-mode');
            if (root.classList.contains('light-mode')) {
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.setItem('theme', 'dark');
            }
            updateThemeIcon();
            // Re-render chart with new theme colors
            if (document.getElementById('overview').classList.contains('hidden') === false) {
                 renderAverageScoreChart();
            }
        };
        
        const applyInitialTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                root.classList.add('light-mode');
            } else {
                root.classList.remove('light-mode');
            }
            updateThemeIcon();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase(); // Main entry point
            
            // Other initializations
            showTab('overview');
            form.addEventListener('submit', handleFormSubmit);
            themeToggleBtn.addEventListener('click', toggleTheme);
            document.getElementById('reset-data-btn').addEventListener('click', resetData);
            applyInitialTheme();
        });
    </script>
</body>
</html>
